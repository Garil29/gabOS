#!/bin/bash

set -e

# ===============================
# Instalador desatendido para gabOS
# Basado en Arch Linux
# ===============================

function log() {
  echo -e "\033[1;32m[INFO]\033[0m $1"
}

function error_exit() {
  echo -e "\033[1;31m[ERROR]\033[0m $1"
  exit 1
}

if [[ $EUID -ne 0 ]]; then
  error_exit "Este script debe ejecutarse como root."
fi

USER_REAL=${SUDO_USER:-$(whoami)}
HOME_REAL=$(eval echo ~$USER_REAL)

log "Actualizando sistema..."
pacman -Syu --noconfirm

log "Instalando herramientas base..."
pacman -S --noconfirm sudo git curl wget neovim unzip htop base-devel

log "Instalando Helix y configurando como editor por defecto..."
pacman -S --noconfirm helix
echo "export EDITOR=hx" >> /etc/environment
echo "export VISUAL=hx" >> /etc/environment

log "Agregando usuario '$USER_REAL' al grupo wheel..."
usermod -aG wheel "$USER_REAL"

log "Instalando Sway y componentes Wayland..."
pacman -S --noconfirm sway wofi kitty xorg-xwayland xdg-utils xdg-desktop-portal-wlr

log "Instalando sonido (Pipewire)..."
pacman -S --noconfirm pipewire wireplumber alsa-utils

log "Instalando TBSM (session manager)..."
pacman -S --noconfirm tbsm

log "Configurando inicio automático de tbsm desde TTY1..."
echo '[[ -z $DISPLAY && $(tty) = /dev/tty1 ]] && exec tbsm' >> "$HOME_REAL/.bash_profile"
chown "$USER_REAL":"$USER_REAL" "$HOME_REAL/.bash_profile"

# === INSTALAR YAY si no existe ===
if ! command -v yay &>/dev/null; then
  log "Instalando yay (helper de AUR)..."
  sudo -u "$USER_REAL" bash -c "
    cd ~
    git clone https://aur.archlinux.org/yay.git
    cd yay
    makepkg -si --noconfirm
  "
fi

# === INSTALAR BRAVE (desde AUR) ===
log "Instalando Brave Browser (desde AUR)..."
sudo -u "$USER_REAL" yay -S --noconfirm brave-bin

# === INSTALAR GVM (OpenVAS desde AUR) ===
log "Instalando GVM (OpenVAS desde AUR)..."
sudo -u "$USER_REAL" yay -S --noconfirm gvm

log "Inicializando base de datos de GVM... (puede tardar)"
sudo -u "$USER_REAL" gvm-setup || error_exit "Falló la inicialización de GVM."
log "Habilitando servicios de GVM..."
systemctl enable --now gvmd ospd-openvas notus-scanner

log "Instalación básica completada."
echo -e "\nReinicia el sistema para iniciar sesión con TTY + tbsm + sway."
echo -e "\n gabOS está listo. ¡Buen hacking, $USER_REAL!"
read -p "Presiona Enter para salir..."
